<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://go-goim.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://go-goim.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://go-goim.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{Object.keys(localStorage).forEach(function(e){/^global-alert-/.test(e)&&document.documentElement.setAttribute("data-global-alert","closed")})})()</script><link rel=stylesheet href=https://go-goim.github.io/main.9fa924d0520dccda9235fa9d16c03681231634d61fc3d1ba4f26a473bdb432f02af126492509f4df67efda70138a3e1b61365d8c0b874ad7ad42ce13a6f10f28.css integrity="sha512-n6kk0FINzNqSNfqdFsA2gSMWNNYfw9G6Tyakc720MvAq8SZJJQn032fv2nATij4bYTZdjAuHStetQs4TpvEPKA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“ - GoIM</title><meta name=description content="åœ¨å¼€å‘å¼€å‘ push service çš„è¿‡ç¨‹ä¸­,æœ‰ä¸€å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ websocket çš„ä½¿ç”¨å’Œè¿æ¥ç®¡ç†ä¸Š,æœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“"><link rel=canonical href=https://go-goim.github.io/blog/push-server-summarize/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“"><meta property="og:description" content="åœ¨å¼€å‘å¼€å‘ push service çš„è¿‡ç¨‹ä¸­,æœ‰ä¸€å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ websocket çš„ä½¿ç”¨å’Œè¿æ¥ç®¡ç†ä¸Š,æœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“"><meta property="og:url" content="https://go-goim.github.io/blog/push-server-summarize/"><meta property="og:site_name" content="GoIM"><meta property="article:published_time" content="2022-06-10T09:19:42+08:00"><meta property="article:modified_time" content="2022-06-10T15:35:12+08:00"><meta property="og:image" content="https://go-goim.github.io/logo_2.png"><meta property="og:image:alt" content="GoIM"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“"><meta name=twitter:description content="åœ¨å¼€å‘å¼€å‘ push service çš„è¿‡ç¨‹ä¸­,æœ‰ä¸€å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ websocket çš„ä½¿ç”¨å’Œè¿æ¥ç®¡ç†ä¸Š,æœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“"><meta name=twitter:image content="https://go-goim.github.io/logo_2.png"><meta name=twitter:image:alt content="æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://go-goim.github.io/#/schema/organization/1","name":"GoIM","url":"https://go-goim.github.io/","sameAs":["https://github.com/go-goim/goim"],"logo":{"@type":"ImageObject","@id":"https://go-goim.github.io/#/schema/image/1","url":"https://go-goim.github.io/icon.png","width":512,"height":512,"caption":"GoIM"},"image":{"@id":"https://go-goim.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://go-goim.github.io/#/schema/website/1","url":"https://go-goim.github.io/","name":"GoIM","description":"Instant Messaging service written in Golang","publisher":{"@id":"https://go-goim.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://go-goim.github.io/blog/push-server-summarize/","url":"https://go-goim.github.io/blog/push-server-summarize/","name":"æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“","description":"åœ¨å¼€å‘å¼€å‘ push service çš„è¿‡ç¨‹ä¸­,æœ‰ä¸€å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ websocket çš„ä½¿ç”¨å’Œè¿æ¥ç®¡ç†ä¸Š,æœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“","isPartOf":{"@id":"https://go-goim.github.io/#/schema/website/1"},"about":{"@id":"https://go-goim.github.io/#/schema/organization/1"},"datePublished":"2022-06-10T09:19:42CET","dateModified":"2022-06-10T15:35:12CET","breadcrumb":{"@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://go-goim.github.io/blog/push-server-summarize/"]}]},{"@type":"BreadcrumbList","@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://go-goim.github.io/","url":"https://go-goim.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://go-goim.github.io/blog/","url":"https://go-goim.github.io/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://go-goim.github.io/blog/push-server-summarize/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://go-goim.github.io/#/schema/article/1","headline":"æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“","description":"åœ¨å¼€å‘å¼€å‘ push service çš„è¿‡ç¨‹ä¸­,æœ‰ä¸€å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ websocket çš„ä½¿ç”¨å’Œè¿æ¥ç®¡ç†ä¸Š,æœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“","isPartOf":{"@id":"https://go-goim.github.io/blog/push-server-summarize/"},"mainEntityOfPage":{"@id":"https://go-goim.github.io/blog/push-server-summarize/"},"datePublished":"2022-06-10T09:19:42CET","dateModified":"2022-06-10T15:35:12CET","author":{"@id":"https://go-goim.github.io/#/schema/person/2"},"publisher":{"@id":"https://go-goim.github.io/#/schema/organization/1"},"image":{"@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://go-goim.github.io/#/schema/person/2","name":"YusanK","sameAs":["https://www.linkedin.com/in/yusan-kurban-037a31a7/","https://github.com/yusank"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/image/2","url":"https://go-goim.github.io/logo_2.png","contentUrl":"https://go-goim.github.io/logo_2.png","caption":"æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://go-goim.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://go-goim.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://go-goim.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://go-goim.github.io/site.webmanifest></head><body class="blog single"><div id=announcement data-id=global-alert-92cc2436bd4df9a43c8f39e3e9fd7fa9 class="alert alert-primary alert-dismissible fade show text-lg-center" role=alert>GoIM still in development. Welcome to join the development! <a class="alert-link stretched-link" href=https://github.com/go-goim/goim target=_blank rel=noopener>Join the development</a>
<button type=button class=btn-close data-bs-dismiss=alert aria-label=Close></button></div><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-fluid flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://go-goim.github.io/ aria-label=GoIM>GoIM</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://go-goim.github.io/>GoIM</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://go-goim.github.io/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://go-goim.github.io/blog/>Blog</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Get Started
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://go-goim.github.io/docs/prologue/quick-start/>Quick Start</a></li><li><a class=dropdown-item href=https://go-goim.github.io/docs/help/faq/>FAQ</a></li></ul></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/go-goim><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></nav></header><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>æ¨é€æœåŠ¡å¼€å‘è¿‡ç¨‹çš„é—®é¢˜æ€»ç»“</h1><p><small>Posted June 10, 2022 by <a class="stretched-link position-relative" href=https://go-goim.github.io/contributors/yusank/>Yusank</a>&nbsp;&dash;&nbsp;<strong>5&nbsp;min read</strong></small><p></div><p class=lead>åœ¨å¼€å‘å¼€å‘ push service çš„è¿‡ç¨‹ä¸­,æœ‰ä¸€å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ websocket çš„ä½¿ç”¨å’Œè¿æ¥ç®¡ç†ä¸Š,æœŸé—´é‡åˆ°äº†ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“</p><ul><li><a href=#%E5%89%8D%E8%A8%80>å‰è¨€</a></li><li><a href=#%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86>äº‹ä»¶ç®¡ç†</a></li><li><a href=#%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86>è¿æ¥ç®¡ç†</a></li><li><a href=#%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81>æ¶ˆæ¯æ¨é€</a></li><li><a href=#%E6%80%BB%E7%BB%93>æ€»ç»“</a></li></ul><h2 id=å‰è¨€>å‰è¨€ <a href=#%e5%89%8d%e8%a8%80 class=anchor aria-hidden=true>#</a></h2><p>push server çš„å¼€å‘æ˜¯åœ¨åš goim çš„å‰æœŸçš„é‡å¤´æˆ,å…¶æ ¸å¿ƒå°±æ˜¯é•¿é“¾æ¥(æœ¬æ¬¡ç”¨ websocket)çš„ç®¡ç†å’Œä¸ä¸šåŠ¡ç›¸äº’ç»“åˆ.</p><p>websocket ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¹…è¿œæˆç†Ÿçš„é•¿é“¾æ¥æ–¹æ¡ˆå†µä¸”æœ‰æˆç†Ÿçš„æ¡†æ¶(æœ¬é¡¹ç›®ä½¿ç”¨çš„ <a href=https://github.com/gorilla/websocket>gorilla/websocket</a>)æ”¯æŒ,æŒ‰ç†æ¥è¯´,å®ƒçš„ä½¿ç”¨åº”è¯¥æ˜¯æ¯”è¾ƒç®€å•çš„,ä½†æ˜¯å®ƒçš„ä½¿ç”¨è¿‡ç¨‹ä¸­,æœ‰ä¸€äº›é—®é¢˜å’ŒæŒ‘æˆ˜,è¿™é‡Œåšä¸€ä¸ªæ€»ç»“.</p><p>è€Œé‡åˆ°çš„é—®é¢˜å¤§éƒ¨åˆ†æ˜¯åœ¨ä½¿ç”¨å’Œä¸ä¸šåŠ¡çš„æ•´åˆä¸Š,å¤§è‡´åˆ†ä¸ºä¸€ä¸‹å‡ ç‚¹:</p><ul><li>äº‹ä»¶ç®¡ç†(å¦‚ ping pong,å¿ƒè·³,æ¶ˆæ¯ç­‰)</li><li>è¿æ¥ç®¡ç†</li><li>æ¶ˆæ¯æ¨é€</li></ul><h2 id=äº‹ä»¶ç®¡ç†>äº‹ä»¶ç®¡ç† <a href=#%e4%ba%8b%e4%bb%b6%e7%ae%a1%e7%90%86 class=anchor aria-hidden=true>#</a></h2><p>åœ¨å»ºç«‹èµ·è¿æ¥ä¹‹å,éœ€è¦å¯¹ä¸€äº› ws æ¶ˆæ¯ç±»å‹åšä¸åŒçš„å¤„ç†,å¦‚ ping/pong æ—¶,è¿æ¥ç®¡ç†å±‚é¢åˆ·æ–°ä¸€äº›è¿æ¥æœ€åæ´»è·ƒæ—¶é—´å·²ç¡®ä¿è¿æ¥å¯ç”¨,è€Œä¸šåŠ¡å±‚é¢éœ€è¦å¯¹è¯¥è¿æ¥å¯¹åº”çš„ç”¨æˆ·
çš„ last_online_time ä¿¡æ¯è¿›è¡Œåˆ·æ–°åŠ¨ä½œ,åˆæ¯”å¦‚ close äº‹ä»¶ä¹Ÿæ˜¯è¿æ¥ç®¡ç†å±‚é¢å’Œä¸šåŠ¡å±‚é¢å„è‡ªéœ€è¦åšå¤„ç†.</p><p>è™½è¯´æ¡†æ¶æä¾›äº†æ³¨å†Œäº‹ä»¶å¤„ç†å™¨çš„æœºåˆ¶,ä½†æ˜¯ä¸è¶³ä»¥æ»¡è¶³éœ€æ±‚.è¿æ¥å±‚æ˜¯çº¯ç²¹ç®¡ç†é•¿é“¾æ¥ä¸ä¾èµ–ä¸šåŠ¡é€»è¾‘ï¼ˆä¸”è¿æ¥å±‚ä¸ä¸šåŠ¡æ˜¯åˆ†å¼€çš„é¡¹ç›®ä»£ç ï¼‰ï¼Œå› æ­¤æ²¡åŠæ³•åœ¨è¿æ¥å±‚ç›´æ¥å¼•å…¥é€»è¾‘å±‚çš„é€»è¾‘å»æ³¨å†Œç›¸å…³å¤„ç†å‡½æ•°ã€‚è€Œä¸šåŠ¡å±‚è™½è¯´å¯ä»¥å¼•å…¥è¿æ¥å±‚çš„é€»è¾‘ï¼Œä½†æ˜¯ä¸åŒä¸šåŠ¡å¤„ç†çš„æ–¹å¼ä¸ä¸€æ ·å¾ˆéš¾ç»Ÿä¸€ç®¡ç†ã€‚</p><p>ä»¥ä¸‹ä¸ºåŸå§‹æ³¨å†Œæ–¹æ³•ï¼Œåªèƒ½æ³¨å†Œå•ä¸ªæ–¹æ³•ï¼Œå¦‚æœéœ€è¦æœ‰å¤šä¸ªå¤„ç†å‡½æ•°åˆ™éœ€è¦æ‰‹åŠ¨åµŒå¥—ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// è¿æ¥å±‚æ³¨å†Œè¿æ¥å±‚çš„äº‹ä»¶å¤„ç†å™¨
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#998;font-style:italic></span>conn.<span style=color:#900;font-weight:700>SetCloseHandler</span>(<span style=color:#000;font-weight:700>func</span>(code <span style=color:#458;font-weight:700>int</span>, text <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    wc.<span style=color:#900;font-weight:700>cancelWithError</span>(<span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    message <span style=color:#000;font-weight:700>:=</span> websocket.<span style=color:#900;font-weight:700>FormatCloseMessage</span>(code, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    _ = wc.conn.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.CloseMessage, message, time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>conn.<span style=color:#900;font-weight:700>SetPingHandler</span>(<span style=color:#000;font-weight:700>func</span>(message <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    err <span style=color:#000;font-weight:700>:=</span> c.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.PongMessage, []<span style=color:#0086b3>byte</span>(message), time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> <span style=color:#000;font-weight:700>||</span> err <span style=color:#000;font-weight:700>==</span> websocket.ErrCloseSent {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>})
</span></span></code></pre></div><div class="alert alert-info d-flex" role=alert><div class="flex-shrink-1 alert-icon">ğŸ‘‰</div><div class=w-100>åŒæ ·çš„äº‹ä»¶éœ€è¦åœ¨ä¸åŒçš„é€»è¾‘å±‚åšä¸åŒçš„å¤„ç†ä¸”ä¸èƒ½ä¾µå…¥åˆ°è¿æ¥å±‚ã€‚</div></div><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¾ˆæ˜æ˜¾æ¡†æ¶æä¾›çš„åŸå§‹çš„ç»“æ„ä½“çš„èƒ½åŠ›æ˜¯ä¸å¤Ÿï¼Œéœ€è¦è¿›è¡Œå°è£…æ‰©å±•ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>type</span> WebsocketConn <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    conn <span style=color:#000;font-weight:700>*</span>websocket.Conn <span style=color:#998;font-style:italic>// åŸå§‹è¿æ¥
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#998;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#998;font-style:italic>// ctx control
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#998;font-style:italic></span>    ctx    context.Context
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    cancel context.CancelFunc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    uid          <span style=color:#458;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>WrapWs</span>(ctx context.Context, c <span style=color:#000;font-weight:700>*</span>websocket.Conn, uid <span style=color:#458;font-weight:700>string</span>) <span style=color:#000;font-weight:700>*</span>WebsocketConn {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#000;font-weight:700>if</span> ctx <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        ctx = context.<span style=color:#900;font-weight:700>Background</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    ctx2, cancel <span style=color:#000;font-weight:700>:=</span> context.<span style=color:#900;font-weight:700>WithCancel</span>(ctx)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    wc <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>&amp;</span>WebsocketConn{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        conn:      c,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        ctx:       ctx2,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        cancel:    cancel,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        uid:       uid,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    wc.conn.<span style=color:#900;font-weight:700>SetCloseHandler</span>(<span style=color:#000;font-weight:700>func</span>(code <span style=color:#458;font-weight:700>int</span>, text <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        wc.<span style=color:#900;font-weight:700>cancelWithError</span>(<span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        message <span style=color:#000;font-weight:700>:=</span> websocket.<span style=color:#900;font-weight:700>FormatCloseMessage</span>(code, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        _ = wc.conn.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.CloseMessage, message, time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    wc.conn.<span style=color:#900;font-weight:700>SetPingHandler</span>(<span style=color:#000;font-weight:700>func</span>(message <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        err <span style=color:#000;font-weight:700>:=</span> c.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.PongMessage, []<span style=color:#0086b3>byte</span>(message), time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> <span style=color:#000;font-weight:700>||</span> err <span style=color:#000;font-weight:700>==</span> websocket.ErrCloseSent {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#000;font-weight:700>return</span> wc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#998;font-style:italic>// é€šè¿‡è¯¥æ–¹æ³•æ³¨å†Œä¸šåŠ¡çš„å¤„ç†æ–¹æ³•
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>AddCloseAction</span>(f <span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    cf <span style=color:#000;font-weight:700>:=</span> w.conn.<span style=color:#900;font-weight:700>CloseHandler</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    w.conn.<span style=color:#900;font-weight:700>SetCloseHandler</span>(<span style=color:#000;font-weight:700>func</span>(code <span style=color:#458;font-weight:700>int</span>, text <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>cf</span>(code, text)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>f</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>        <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#998;font-style:italic>// é€šè¿‡è¯¥æ–¹æ³•æ³¨å†Œä¸šåŠ¡çš„å¤„ç†æ–¹æ³•
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>AddPingAction</span>(f <span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    pf <span style=color:#000;font-weight:700>:=</span> w.conn.<span style=color:#900;font-weight:700>PingHandler</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    w.conn.<span style=color:#900;font-weight:700>SetPingHandler</span>(<span style=color:#000;font-weight:700>func</span>(appData <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>        err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>pf</span>(appData)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>f</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>}
</span></span></code></pre></div><p>åœ¨è¿æ¥å±‚å°†åŸå§‹ conn è¿›è¡Œä¸€å±‚å°è£…ï¼Œé€»è¾‘å±‚èƒ½å–åˆ°å°è£…åçš„è¿æ¥ï¼Œå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚æ³¨å†Œä»»æ„æ•°é‡çš„äº‹ä»¶å¤„ç†å™¨ã€‚è€Œè¿æ¥å±‚åœ¨å°è£…è¿æ¥æ—¶å°±å°†è¿æ¥å±‚éœ€è¦çš„å¤„ç†æ–¹æ³•æ³¨å†Œè¿›å»äº†ã€‚</p><p>ç°åœ¨çœ‹ä¸€ä¸‹ä¸šåŠ¡å±‚çš„ä½¿ç”¨æ–¹å¼ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// å»ºç«‹è¿æ¥å¹¶å°è£…åæ³¨å†Œä¸šåŠ¡å¤„ç†å‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#998;font-style:italic></span>wc.<span style=color:#900;font-weight:700>AddPingAction</span>(<span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>return</span> app.<span style=color:#900;font-weight:700>GetApplication</span>().Redis.<span style=color:#900;font-weight:700>SetEX</span>(context.<span style=color:#900;font-weight:700>Background</span>(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        consts.<span style=color:#900;font-weight:700>GetUserOnlineAgentKey</span>(uid), app.<span style=color:#900;font-weight:700>GetAgentIP</span>(), consts.UserOnlineAgentKeyExpire).<span style=color:#900;font-weight:700>Err</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#998;font-style:italic>// å»ºç«‹è¿æ¥å¹¶å°è£…åæ³¨å†Œä¸šåŠ¡å¤„ç†å‡½æ•°
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#998;font-style:italic></span>wc.<span style=color:#900;font-weight:700>AddCloseAction</span>(<span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ctx2, cancel <span style=color:#000;font-weight:700>:=</span> context.<span style=color:#900;font-weight:700>WithTimeout</span>(ctx, time.Second)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#000;font-weight:700>defer</span> <span style=color:#900;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>return</span> app.<span style=color:#900;font-weight:700>GetApplication</span>().Redis.<span style=color:#900;font-weight:700>Del</span>(ctx2, consts.<span style=color:#900;font-weight:700>GetUserOnlineAgentKey</span>(uid)).<span style=color:#900;font-weight:700>Err</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>})
</span></span></code></pre></div><p>è¿™æ ·å°±æŠŠä¸šåŠ¡å’Œè¿æ¥ç®¡ç†æ‹†åˆ†å¼€äº’ä¸å½±å“ï¼Œè¿æ¥å±‚ä¸å…³å¿ƒä¸Šå±‚ä¸šåŠ¡æ€ä¹ˆå¤„ç†ï¼Œåªå…³å¿ƒè¿æ¥çš„æ­£å¸¸å¯ç”¨å³å¯ã€‚</p><h2 id=è¿æ¥ç®¡ç†>è¿æ¥ç®¡ç† <a href=#%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86 class=anchor aria-hidden=true>#</a></h2><p>è¿æ¥ç®¡ç†ä¹Ÿæ˜¯èŠ±å¿ƒæ€æ¯”è¾ƒå¤šçš„æ¨¡å—ï¼Œç”±äº websocket çš„è¿æ¥ä¸åŒäºæ™®é€šçš„è¿æ¥ï¼Œå› æ­¤æ²¡åŠæ³•ç”¨æ™®é€šçš„è¿æ¥æ± æ¥ç®¡ç†ï¼ˆå…¶å®æˆ‘å·²ç»æœ‰ä¸€å¥—å¯ç”¨çš„è¿æ¥æ± çš„æ–¹æ¡ˆäº†<a href=https://github.com/yusank/conn-pool>yusank/conn-pool</a>ï¼Œå¯æƒœäº†ï¼‰ã€‚</p><p>websocket çš„æ¯ä¸ªè¿æ¥éƒ½æ˜¯å”¯ä¸€çš„ä¸”éœ€è¦æ ¹æ®ä¸€äº›å”¯ä¸€çš„å€¼ï¼ˆUIDï¼ŒsessionID ç­‰ï¼‰æ¥æ‹¿åˆ°å¯¹åº”çš„è¿æ¥ï¼Œè¿™äº›è¿æ¥ä¹Ÿä¸æ˜¯è¿æ¥æ± åˆå§‹åŒ–å‡ºæ¥çš„ï¼Œæ˜¯å¤–éƒ¨ä¼ è¿›å»è®©è¿æ¥æ± å»ç»´æŠ¤è¿™äº›è¿æ¥ã€‚</p><p>åŒæ—¶ websocket è¿æ¥éšæ—¶å¯èƒ½æ–­å¼€ï¼Œè¿™ç§æ–­å¼€å¯èƒ½ä¸»åŠ¨çš„ä¹Ÿå¯èƒ½æ˜¯è¿ç»­å‡ ä¸ªå¿ƒè·³å‘¨æœŸæ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³åŒ…ä»è€ŒæœåŠ¡ç«¯ä¸»åŠ¨æ–­å¼€çš„ï¼Œä¸ç®¡æ˜¯é‚£ç§æƒ…å†µï¼Œåœ¨è¿æ¥å±‚éœ€è¦æœ‰ä¸ª goroutine å»ç»´æŠ¤è¿™ä¸ªè¿æ¥çš„å¯ç”¨æ€§ã€‚åœ¨è¿æ¥éœ€è¦æ–­å¼€æ—¶ï¼Œåœæ­¢ç»´æŠ¤å¹¶ä»è¿æ¥æ± åˆ é™¤è¯¥è¿æ¥ã€‚</p><p>ä¸ºäº†ç¡®ä¿ <code>WebsocketConn</code> çš„çº¯æ´æ€§ï¼Œåœ¨ç»´æŠ¤è¿æ¥æ¨¡å—é‡Œå®šä¹‰ä¸€ä¸ªç®€å•çš„<code>è¿æ¥</code>çš„æ¦‚å¿µ,æŠŠ <code>WebsocketConn</code> å°è£…èµ·æ¥ã€‚</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>type</span> idleConn <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#000;font-weight:700>*</span>WebsocketConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    p        <span style=color:#000;font-weight:700>*</span>namedPool <span style=color:#998;font-style:italic>// è¿æ¥æ± 
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#998;font-style:italic></span>    stopChan <span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>struct</span>{}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#998;font-style:italic>// close is different form stop
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#998;font-style:italic>// close is closes the connection and delete it from pool
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic>// stop is a trigger to stop the daemon then call the close
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (i <span style=color:#000;font-weight:700>*</span>idleConn) <span style=color:#0086b3>close</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    _ = i.<span style=color:#900;font-weight:700>Close</span>() <span style=color:#998;font-style:italic>// i.WebsocketConn.Close()
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#998;font-style:italic></span>    i.p.<span style=color:#0086b3>delete</span>(i.<span style=color:#900;font-weight:700>Key</span>()) <span style=color:#998;font-style:italic>// i.WebsocketConn.Key() =&gt; uid
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#998;font-style:italic></span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#000;font-weight:700>func</span> (i <span style=color:#000;font-weight:700>*</span>idleConn) <span style=color:#900;font-weight:700>stop</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    i.stopChan <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#000;font-weight:700>struct</span>{}{}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#000;font-weight:700>func</span> (i <span style=color:#000;font-weight:700>*</span>idleConn) <span style=color:#900;font-weight:700>daemon</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ticker <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>NewTicker</span>(config.Interval <span style=color:#000;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>loop:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#000;font-weight:700>for</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span> ticker.C:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>             <span style=color:#998;font-style:italic>// check last ping time and decide whether stop daemon.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>i.ctx.<span style=color:#900;font-weight:700>Done</span>():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#998;font-style:italic>// WebsocketConn ctx cancelled
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#998;font-style:italic></span>            log.<span style=color:#900;font-weight:700>Error</span>(<span style=color:#d14>&#34;conn done&#34;</span>, <span style=color:#d14>&#34;key&#34;</span>, i.<span style=color:#900;font-weight:700>Key</span>())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#000;font-weight:700>break</span> loop
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#998;font-style:italic>//  stop() called
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>i.stopChan:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            log.<span style=color:#900;font-weight:700>Info</span>(<span style=color:#d14>&#34;conn stop&#34;</span>, <span style=color:#d14>&#34;key&#34;</span>, i.<span style=color:#900;font-weight:700>Key</span>())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#000;font-weight:700>break</span> loop
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#000;font-weight:700>case</span> data <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>&lt;-</span>i.writeChan:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            i.<span style=color:#900;font-weight:700>writeToClient</span>(data) <span style=color:#998;font-style:italic>// write msg to client
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#998;font-style:italic></span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    log.<span style=color:#900;font-weight:700>Info</span>(<span style=color:#d14>&#34;conn daemon exit&#34;</span>, <span style=color:#d14>&#34;key&#34;</span>, i.<span style=color:#900;font-weight:700>Key</span>())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    i.<span style=color:#0086b3>close</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>}
</span></span></code></pre></div><p><code>idleConn</code> èƒ½åŠ›ç›¸å¯¹çº¯ç²¹ï¼Œç»´æŠ¤è¿æ¥å¯ç”¨æ€§å’Œç‰¹æ®Šæƒ…å†µä¸‹ä»è¿æ¥æ± å‰”é™¤å½“å‰è¿æ¥ã€‚</p><p>ä¸‹é¢çœ‹ä¸€ä¸‹è¿æ¥æ± çš„å®šä¹‰å’Œå®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>type</span> namedPool <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#000;font-weight:700>*</span>sync.RWMutex
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    m <span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>string</span>]<span style=color:#000;font-weight:700>*</span>idleConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>newNamedPool</span>() <span style=color:#000;font-weight:700>*</span>namedPool {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    p <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>&amp;</span>namedPool{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        RWMutex: <span style=color:#0086b3>new</span>(sync.RWMutex),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        m:       <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>string</span>]<span style=color:#000;font-weight:700>*</span>idleConn),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#000;font-weight:700>return</span> p
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#998;font-style:italic>// æ·»åŠ è¿æ¥
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#900;font-weight:700>add</span>(c <span style=color:#000;font-weight:700>*</span>WebsocketConn) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>c.ctx.<span style=color:#900;font-weight:700>Done</span>():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#000;font-weight:700>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#000;font-weight:700>if</span> c.<span style=color:#900;font-weight:700>Err</span>() <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    p.<span style=color:#900;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#000;font-weight:700>defer</span> p.<span style=color:#900;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#998;font-style:italic>// è‹¥å·²å­˜åœ¨ åˆ™å…ˆåœæ­¢ä¸Šä¸€ä¸ª daemon
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#998;font-style:italic></span>    i, loaded <span style=color:#000;font-weight:700>:=</span> p.m[c.<span style=color:#900;font-weight:700>Key</span>()]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#000;font-weight:700>if</span> loaded {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        i.<span style=color:#900;font-weight:700>stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    i = <span style=color:#000;font-weight:700>&amp;</span>idleConn{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        WebsocketConn: c,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        stopChan:      <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>struct</span>{}),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        p:             p,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#998;font-style:italic>// TODO: ä½¿ç”¨å¯æ§å¤§å°çš„ goroutine æ± ï¼Œé˜²æ­¢goroutine æ³„éœ²
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>go</span> i.<span style=color:#900;font-weight:700>daemon</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    p.m[c.<span style=color:#900;font-weight:700>Key</span>()] = i
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#900;font-weight:700>get</span>(key <span style=color:#458;font-weight:700>string</span>) <span style=color:#000;font-weight:700>*</span>WebsocketConn {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    p.<span style=color:#900;font-weight:700>RLock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    i, ok <span style=color:#000;font-weight:700>:=</span> p.m[key]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    p.<span style=color:#900;font-weight:700>RUnlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    <span style=color:#000;font-weight:700>if</span> ok {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        <span style=color:#998;font-style:italic>// æ‹¿è¿æ¥æ—¶ å…ˆåˆ¤æ–­æ˜¯å¦å·²å¤±æ•ˆ
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>i.ctx.<span style=color:#900;font-weight:700>Done</span>():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            i.<span style=color:#900;font-weight:700>stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>        <span style=color:#000;font-weight:700>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>            <span style=color:#000;font-weight:700>if</span> i.<span style=color:#900;font-weight:700>Err</span>() <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                i.<span style=color:#900;font-weight:700>stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            <span style=color:#000;font-weight:700>return</span> i.WebsocketConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#998;font-style:italic>// éœ€è¦è¯»å–æ‰€æœ‰è¿æ¥åšå…¨é‡æ¨é€çš„éœ€æ±‚
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#900;font-weight:700>loadAllConns</span>() <span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>*</span>WebsocketConn {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    p.<span style=color:#900;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>    <span style=color:#000;font-weight:700>defer</span> p.<span style=color:#900;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    ch <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>*</span>WebsocketConn, <span style=color:#0086b3>len</span>(p.m))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>    <span style=color:#000;font-weight:700>for</span> _, i <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>range</span> p.m {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        ch <span style=color:#000;font-weight:700>&lt;-</span> i.WebsocketConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>    <span style=color:#0086b3>close</span>(ch)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>    <span style=color:#000;font-weight:700>return</span> ch
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#0086b3>delete</span>(key <span style=color:#458;font-weight:700>string</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>    p.<span style=color:#900;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#000;font-weight:700>defer</span> p.<span style=color:#900;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>    <span style=color:#0086b3>delete</span>(p.m, key)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>}
</span></span></code></pre></div><p>ç»è¿‡ <code>idleConn</code> å’Œ <code>namedPool</code> é…åˆï¼Œè¿æ¥ç®¡ç†ç®—æ˜¯è¾¾åˆ°é¢„æœŸçš„è¦æ±‚äº†ä¸”é€šè¿‡äº†æµ‹è¯•ï¼ŒåæœŸå¯ä»¥åšä¸€äº›ä¼˜åŒ–é¡¹ã€‚</p><h2 id=æ¶ˆæ¯æ¨é€>æ¶ˆæ¯æ¨é€ <a href=#%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81 class=anchor aria-hidden=true>#</a></h2><p>åœ¨è§£å†³äº†éä¸šåŠ¡å±‚çš„å„ç§é—®é¢˜åï¼Œç°åœ¨åªå‰©ä¸‹æ¶ˆæ¯æ¨é€çš„é—®é¢˜äº†ã€‚æ¶ˆæ¯æ¨é€æœ€å¼€å§‹å…¶å®ç›´æ¥è°ƒç”¨çš„æ¡†æ¶æä¾›çš„åŸç”Ÿæ–¹æ³• <code>WriteMessage</code>,å³éœ€è¦æ¨é€æ—¶ï¼Œä»è¿æ¥æ± æ‹¿åˆ°å¯¹åº”çš„è¿æ¥ç„¶åç›´æ¥è°ƒç”¨å†™æ¶ˆæ¯çš„æ–¹æ³•ï¼Œä½†æ˜¯æœ‰å¤§é‡æ¶ˆæ¯éœ€è¦å†™å…¥æ—¶å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯é¡ºåºå¼‚å¸¸çš„é—®é¢˜ï¼Œå› æ­¤åœ¨ <code>WebsocketConn</code> å±‚å±è”½äº†åŸç”Ÿçš„æ–¹æ³•ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ¶ˆæ¯ <code>channel</code> æ¥æ§åˆ¶å¹¶å‘å¸¦æ¥çš„æ¶ˆæ¯é¡ºåºå¼‚å¸¸é—®é¢˜ã€‚</p><p>æ–°å¢æ¶ˆæ¯ <code>channel</code> :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    conn *websocket.Conn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ctx    context.Context
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    cancel context.CancelFunc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    uid          string
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    // æ¶ˆæ¯ channel
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    writeChan    chan []byte
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    // æ— æ³•å†™åˆ°å®¢æˆ·ç«¯æ—¶å›è°ƒè¯¥æ–¹æ³• ä¸Šå±‚ä¸€èˆ¬ä¼šè¿›è¡Œé‡è¯•æˆ–å†™åˆ° mq å¾…ä¼šå„¿è¿›è¡Œå¤„ç†
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    onWriteError func()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    err          error
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>æ–°çš„å†™æ¶ˆæ¯æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>Write</span>(data []<span style=color:#458;font-weight:700>byte</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>case</span> w.writeChan <span style=color:#000;font-weight:700>&lt;-</span> data:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#000;font-weight:700>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#998;font-style:italic>// å°è¯•ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…å†™å…¥å¤±è´¥åˆ™ç›´æ¥æŠ¥é”™ï¼Œè¿™ç§æƒ…å†µä¸‹å¤§æ¦‚ç‡æ˜¯æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„è¿æ¥å¼‚å¸¸ï¼Œæ¶ˆæ¯é˜»å¡äº†
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic></span>    timer <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>NewTimer</span>(time.Millisecond <span style=color:#000;font-weight:700>*</span> <span style=color:#099>10</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>case</span> w.writeChan <span style=color:#000;font-weight:700>&lt;-</span> data:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>timer.C:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#000;font-weight:700>return</span> ErrWriteChanFull
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p>å†™å…¥åˆ° <code>writeChan</code> åï¼Œç”±ä¸Šè¿° <code>idleConn.daemon</code> æ–¹æ³•è¯»å– <code>channel</code> å†…æ¶ˆæ¯åï¼Œè°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ¥æ­£å¼å†™å…¥çš„ws ä¸Šï¼š</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>writeToClient</span>(data []<span style=color:#458;font-weight:700>byte</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    _ = w.conn.<span style=color:#900;font-weight:700>SetWriteDeadline</span>(time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    err <span style=color:#000;font-weight:700>:=</span> w.conn.<span style=color:#900;font-weight:700>WriteMessage</span>(websocket.TextMessage, data)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        w.<span style=color:#900;font-weight:700>onWriteError</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œæ¶ˆæ¯çš„æ¨é€ä¹Ÿè§£å†³äº†å·²é‡åˆ°çš„é—®é¢˜ã€‚</p><h2 id=æ€»ç»“>æ€»ç»“ <a href=#%e6%80%bb%e7%bb%93 class=anchor aria-hidden=true>#</a></h2><p>æœ¬æ–‡è®°å½•äº†åœ¨å¼€å‘ goim çš„æ¨é€æœåŠ¡(é•¿è¿æ¥æœåŠ¡)æ—¶é‡åˆ°çš„ä¸€äº›é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼Œæ–¹ä¾¿ç†è§£åœ¨çœ‹ç›¸å…³ä»£ç æ—¶å…¶èƒŒåçš„æ€è€ƒã€‚</p><p>å†…å®¹åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>websocket è¿æ¥ä¸­çš„ä¸€äº›äº‹ä»¶å¤„ç†å’Œå¦‚ä½•ä¸ä¸šåŠ¡å…³è”èµ·æ¥</li><li>websocket è¿æ¥æ± çš„ç»´æŠ¤</li><li>åœ¨èŠå¤©ç³»ç»Ÿä¸­ç¡®ä¿æ¶ˆæ¯æ¨é€çš„é¡ºåº</li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://go-goim.github.io/js/bootstrap.min.0a0106334435d4110713bfaff4acaf02533b0c56d44412a74e9518db07672ddb7e099a9c7517bc9cb529e2ddd4ae2e438b40b720288900d5e74fb6d8928d9097.js integrity="sha512-CgEGM0Q11BEHE7+v9KyvAlM7DFbURBKnTpUY2wdnLdt+CZqcdRe8nLUp4t3Uri5Di0C3ICiJANXnT7bYko2Qlw==" crossorigin=anonymous defer></script>
<script src=https://go-goim.github.io/main.min.8af0270b47fb32a37fe246141900e6daf60fd994e5e871a785199a9779f9dbd0eeae617675535eb47b71f7190ad25f8df4477b6cfd453c1879bea3a35e290333.js integrity="sha512-ivAnC0f7MqN/4kYUGQDm2vYP2ZTl6HGnhRmal3n529DurmF2dVNetHtx9xkK0l+N9Ed7bP1FPBh5vqOjXikDMw==" crossorigin=anonymous defer></script></body></html>