<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://go-goim.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://go-goim.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://go-goim.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{Object.keys(localStorage).forEach(function(e){/^global-alert-/.test(e)&&document.documentElement.setAttribute("data-global-alert","closed")})})()</script><link rel=stylesheet href=https://go-goim.github.io/main.9fa924d0520dccda9235fa9d16c03681231634d61fc3d1ba4f26a473bdb432f02af126492509f4df67efda70138a3e1b61365d8c0b874ad7ad42ce13a6f10f28.css integrity="sha512-n6kk0FINzNqSNfqdFsA2gSMWNNYfw9G6Tyakc720MvAq8SZJJQn032fv2nATij4bYTZdjAuHStetQs4TpvEPKA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>推送服务开发过程的问题总结 - GoIM</title><meta name=description content="在开发开发 push service 的过程中,有一大部分时间花在 websocket 的使用和连接管理上,期间遇到了一些问题和挑战,这里做一个总结"><link rel=canonical href=https://go-goim.github.io/blog/push-server-summarize/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="推送服务开发过程的问题总结"><meta property="og:description" content="在开发开发 push service 的过程中,有一大部分时间花在 websocket 的使用和连接管理上,期间遇到了一些问题和挑战,这里做一个总结"><meta property="og:url" content="https://go-goim.github.io/blog/push-server-summarize/"><meta property="og:site_name" content="GoIM"><meta property="article:published_time" content="2022-06-10T09:19:42+08:00"><meta property="article:modified_time" content="2022-06-10T15:35:12+08:00"><meta property="og:image" content="https://go-goim.github.io/logo_2.png"><meta property="og:image:alt" content="GoIM"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content><meta name=twitter:creator content><meta name=twitter:title content="推送服务开发过程的问题总结"><meta name=twitter:description content="在开发开发 push service 的过程中,有一大部分时间花在 websocket 的使用和连接管理上,期间遇到了一些问题和挑战,这里做一个总结"><meta name=twitter:image content="https://go-goim.github.io/logo_2.png"><meta name=twitter:image:alt content="推送服务开发过程的问题总结"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://go-goim.github.io/#/schema/organization/1","name":"GoIM","url":"https://go-goim.github.io/","sameAs":["https://github.com/go-goim/goim"],"logo":{"@type":"ImageObject","@id":"https://go-goim.github.io/#/schema/image/1","url":"https://go-goim.github.io/icon.png","width":512,"height":512,"caption":"GoIM"},"image":{"@id":"https://go-goim.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://go-goim.github.io/#/schema/website/1","url":"https://go-goim.github.io/","name":"GoIM","description":"Instant Messaging service written in Golang","publisher":{"@id":"https://go-goim.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://go-goim.github.io/blog/push-server-summarize/","url":"https://go-goim.github.io/blog/push-server-summarize/","name":"推送服务开发过程的问题总结","description":"在开发开发 push service 的过程中,有一大部分时间花在 websocket 的使用和连接管理上,期间遇到了一些问题和挑战,这里做一个总结","isPartOf":{"@id":"https://go-goim.github.io/#/schema/website/1"},"about":{"@id":"https://go-goim.github.io/#/schema/organization/1"},"datePublished":"2022-06-10T09:19:42CET","dateModified":"2022-06-10T15:35:12CET","breadcrumb":{"@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://go-goim.github.io/blog/push-server-summarize/"]}]},{"@type":"BreadcrumbList","@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://go-goim.github.io/","url":"https://go-goim.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://go-goim.github.io/blog/","url":"https://go-goim.github.io/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://go-goim.github.io/blog/push-server-summarize/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://go-goim.github.io/#/schema/article/1","headline":"推送服务开发过程的问题总结","description":"在开发开发 push service 的过程中,有一大部分时间花在 websocket 的使用和连接管理上,期间遇到了一些问题和挑战,这里做一个总结","isPartOf":{"@id":"https://go-goim.github.io/blog/push-server-summarize/"},"mainEntityOfPage":{"@id":"https://go-goim.github.io/blog/push-server-summarize/"},"datePublished":"2022-06-10T09:19:42CET","dateModified":"2022-06-10T15:35:12CET","author":{"@id":"https://go-goim.github.io/#/schema/person/2"},"publisher":{"@id":"https://go-goim.github.io/#/schema/organization/1"},"image":{"@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://go-goim.github.io/#/schema/person/2","name":"YusanK","sameAs":["https://www.linkedin.com/in/yusan-kurban-037a31a7/","https://github.com/yusank"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://go-goim.github.io/blog/push-server-summarize/#/schema/image/2","url":"https://go-goim.github.io/logo_2.png","contentUrl":"https://go-goim.github.io/logo_2.png","caption":"推送服务开发过程的问题总结"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://go-goim.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://go-goim.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://go-goim.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://go-goim.github.io/site.webmanifest></head><body class="blog single"><div id=announcement data-id=global-alert-92cc2436bd4df9a43c8f39e3e9fd7fa9 class="alert alert-primary alert-dismissible fade show text-lg-center" role=alert>GoIM still in development. Welcome to join the development! <a class="alert-link stretched-link" href=https://github.com/go-goim/goim target=_blank rel=noopener>Join the development</a>
<button type=button class=btn-close data-bs-dismiss=alert aria-label=Close></button></div><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-fluid flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://go-goim.github.io/ aria-label=GoIM>GoIM</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://go-goim.github.io/>GoIM</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://go-goim.github.io/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://go-goim.github.io/blog/>Blog</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Get Started
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://go-goim.github.io/docs/prologue/quick-start/>Quick Start</a></li><li><a class=dropdown-item href=https://go-goim.github.io/docs/help/faq/>FAQ</a></li></ul></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/go-goim><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div></nav></header><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>推送服务开发过程的问题总结</h1><p><small>Posted June 10, 2022 by <a class="stretched-link position-relative" href=https://go-goim.github.io/contributors/yusank/>Yusank</a>&nbsp;&dash;&nbsp;<strong>5&nbsp;min read</strong></small><p></div><p class=lead>在开发开发 push service 的过程中,有一大部分时间花在 websocket 的使用和连接管理上,期间遇到了一些问题和挑战,这里做一个总结</p><ul><li><a href=#%E5%89%8D%E8%A8%80>前言</a></li><li><a href=#%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86>事件管理</a></li><li><a href=#%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86>连接管理</a></li><li><a href=#%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81>消息推送</a></li><li><a href=#%E6%80%BB%E7%BB%93>总结</a></li></ul><h2 id=前言>前言 <a href=#%e5%89%8d%e8%a8%80 class=anchor aria-hidden=true>#</a></h2><p>push server 的开发是在做 goim 的前期的重头戏,其核心就是长链接(本次用 websocket)的管理和与业务相互结合.</p><p>websocket 算是一个比较久远成熟的长链接方案况且有成熟的框架(本项目使用的 <a href=https://github.com/gorilla/websocket>gorilla/websocket</a>)支持,按理来说,它的使用应该是比较简单的,但是它的使用过程中,有一些问题和挑战,这里做一个总结.</p><p>而遇到的问题大部分是在使用和与业务的整合上,大致分为一下几点:</p><ul><li>事件管理(如 ping pong,心跳,消息等)</li><li>连接管理</li><li>消息推送</li></ul><h2 id=事件管理>事件管理 <a href=#%e4%ba%8b%e4%bb%b6%e7%ae%a1%e7%90%86 class=anchor aria-hidden=true>#</a></h2><p>在建立起连接之后,需要对一些 ws 消息类型做不同的处理,如 ping/pong 时,连接管理层面刷新一些连接最后活跃时间已确保连接可用,而业务层面需要对该连接对应的用户
的 last_online_time 信息进行刷新动作,又比如 close 事件也是连接管理层面和业务层面各自需要做处理.</p><p>虽说框架提供了注册事件处理器的机制,但是不足以满足需求.连接层是纯粹管理长链接不依赖业务逻辑（且连接层与业务是分开的项目代码），因此没办法在连接层直接引入逻辑层的逻辑去注册相关处理函数。而业务层虽说可以引入连接层的逻辑，但是不同业务处理的方式不一样很难统一管理。</p><p>以下为原始注册方法，只能注册单个方法，如果需要有多个处理函数则需要手动嵌套：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// 连接层注册连接层的事件处理器
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#998;font-style:italic></span>conn.<span style=color:#900;font-weight:700>SetCloseHandler</span>(<span style=color:#000;font-weight:700>func</span>(code <span style=color:#458;font-weight:700>int</span>, text <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    wc.<span style=color:#900;font-weight:700>cancelWithError</span>(<span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    message <span style=color:#000;font-weight:700>:=</span> websocket.<span style=color:#900;font-weight:700>FormatCloseMessage</span>(code, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    _ = wc.conn.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.CloseMessage, message, time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>conn.<span style=color:#900;font-weight:700>SetPingHandler</span>(<span style=color:#000;font-weight:700>func</span>(message <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    err <span style=color:#000;font-weight:700>:=</span> c.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.PongMessage, []<span style=color:#0086b3>byte</span>(message), time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> <span style=color:#000;font-weight:700>||</span> err <span style=color:#000;font-weight:700>==</span> websocket.ErrCloseSent {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>})
</span></span></code></pre></div><div class="alert alert-info d-flex" role=alert><div class="flex-shrink-1 alert-icon">👉</div><div class=w-100>同样的事件需要在不同的逻辑层做不同的处理且不能侵入到连接层。</div></div><p>为了解决这个问题，很明显框架提供的原始的结构体的能力是不够，需要进行封装扩展。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>type</span> WebsocketConn <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    conn <span style=color:#000;font-weight:700>*</span>websocket.Conn <span style=color:#998;font-style:italic>// 原始连接
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#998;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#998;font-style:italic>// ctx control
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#998;font-style:italic></span>    ctx    context.Context
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    cancel context.CancelFunc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    uid          <span style=color:#458;font-weight:700>string</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>WrapWs</span>(ctx context.Context, c <span style=color:#000;font-weight:700>*</span>websocket.Conn, uid <span style=color:#458;font-weight:700>string</span>) <span style=color:#000;font-weight:700>*</span>WebsocketConn {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#000;font-weight:700>if</span> ctx <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        ctx = context.<span style=color:#900;font-weight:700>Background</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    ctx2, cancel <span style=color:#000;font-weight:700>:=</span> context.<span style=color:#900;font-weight:700>WithCancel</span>(ctx)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    wc <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>&amp;</span>WebsocketConn{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        conn:      c,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        ctx:       ctx2,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        cancel:    cancel,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        uid:       uid,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    wc.conn.<span style=color:#900;font-weight:700>SetCloseHandler</span>(<span style=color:#000;font-weight:700>func</span>(code <span style=color:#458;font-weight:700>int</span>, text <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        wc.<span style=color:#900;font-weight:700>cancelWithError</span>(<span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        message <span style=color:#000;font-weight:700>:=</span> websocket.<span style=color:#900;font-weight:700>FormatCloseMessage</span>(code, <span style=color:#d14>&#34;&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        _ = wc.conn.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.CloseMessage, message, time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>    wc.conn.<span style=color:#900;font-weight:700>SetPingHandler</span>(<span style=color:#000;font-weight:700>func</span>(message <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>        err <span style=color:#000;font-weight:700>:=</span> c.<span style=color:#900;font-weight:700>WriteControl</span>(websocket.PongMessage, []<span style=color:#0086b3>byte</span>(message), time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> <span style=color:#000;font-weight:700>||</span> err <span style=color:#000;font-weight:700>==</span> websocket.ErrCloseSent {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#000;font-weight:700>return</span> wc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#998;font-style:italic>// 通过该方法注册业务的处理方法
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>AddCloseAction</span>(f <span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    cf <span style=color:#000;font-weight:700>:=</span> w.conn.<span style=color:#900;font-weight:700>CloseHandler</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    w.conn.<span style=color:#900;font-weight:700>SetCloseHandler</span>(<span style=color:#000;font-weight:700>func</span>(code <span style=color:#458;font-weight:700>int</span>, text <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>        err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>cf</span>(code, text)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>f</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>        <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span><span style=color:#998;font-style:italic>// 通过该方法注册业务的处理方法
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>AddPingAction</span>(f <span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    pf <span style=color:#000;font-weight:700>:=</span> w.conn.<span style=color:#900;font-weight:700>PingHandler</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    w.conn.<span style=color:#900;font-weight:700>SetPingHandler</span>(<span style=color:#000;font-weight:700>func</span>(appData <span style=color:#458;font-weight:700>string</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>        err <span style=color:#000;font-weight:700>:=</span> <span style=color:#900;font-weight:700>pf</span>(appData)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>        <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>==</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>            <span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>f</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>        <span style=color:#000;font-weight:700>return</span> err
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span>}
</span></span></code></pre></div><p>在连接层将原始 conn 进行一层封装，逻辑层能取到封装后的连接，可根据业务需求注册任意数量的事件处理器。而连接层在封装连接时就将连接层需要的处理方法注册进去了。</p><p>现在看一下业务层的使用方式：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// 建立连接并封装后注册业务处理函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#998;font-style:italic></span>wc.<span style=color:#900;font-weight:700>AddPingAction</span>(<span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>return</span> app.<span style=color:#900;font-weight:700>GetApplication</span>().Redis.<span style=color:#900;font-weight:700>SetEX</span>(context.<span style=color:#900;font-weight:700>Background</span>(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        consts.<span style=color:#900;font-weight:700>GetUserOnlineAgentKey</span>(uid), app.<span style=color:#900;font-weight:700>GetAgentIP</span>(), consts.UserOnlineAgentKeyExpire).<span style=color:#900;font-weight:700>Err</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>})
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#998;font-style:italic>// 建立连接并封装后注册业务处理函数
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#998;font-style:italic></span>wc.<span style=color:#900;font-weight:700>AddCloseAction</span>(<span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    ctx2, cancel <span style=color:#000;font-weight:700>:=</span> context.<span style=color:#900;font-weight:700>WithTimeout</span>(ctx, time.Second)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#000;font-weight:700>defer</span> <span style=color:#900;font-weight:700>cancel</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>return</span> app.<span style=color:#900;font-weight:700>GetApplication</span>().Redis.<span style=color:#900;font-weight:700>Del</span>(ctx2, consts.<span style=color:#900;font-weight:700>GetUserOnlineAgentKey</span>(uid)).<span style=color:#900;font-weight:700>Err</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>})
</span></span></code></pre></div><p>这样就把业务和连接管理拆分开互不影响，连接层不关心上层业务怎么处理，只关心连接的正常可用即可。</p><h2 id=连接管理>连接管理 <a href=#%e8%bf%9e%e6%8e%a5%e7%ae%a1%e7%90%86 class=anchor aria-hidden=true>#</a></h2><p>连接管理也是花心思比较多的模块，由于 websocket 的连接不同于普通的连接，因此没办法用普通的连接池来管理（其实我已经有一套可用的连接池的方案了<a href=https://github.com/yusank/conn-pool>yusank/conn-pool</a>，可惜了）。</p><p>websocket 的每个连接都是唯一的且需要根据一些唯一的值（UID，sessionID 等）来拿到对应的连接，这些连接也不是连接池初始化出来的，是外部传进去让连接池去维护这些连接。</p><p>同时 websocket 连接随时可能断开，这种断开可能主动的也可能是连续几个心跳周期没有收到客户端的心跳包从而服务端主动断开的，不管是那种情况，在连接层需要有个 goroutine 去维护这个连接的可用性。在连接需要断开时，停止维护并从连接池删除该连接。</p><p>为了确保 <code>WebsocketConn</code> 的纯洁性，在维护连接模块里定义一个简单的<code>连接</code>的概念,把 <code>WebsocketConn</code> 封装起来。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>type</span> idleConn <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#000;font-weight:700>*</span>WebsocketConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    p        <span style=color:#000;font-weight:700>*</span>namedPool <span style=color:#998;font-style:italic>// 连接池
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#998;font-style:italic></span>    stopChan <span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>struct</span>{}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#998;font-style:italic>// close is different form stop
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#998;font-style:italic>// close is closes the connection and delete it from pool
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic>// stop is a trigger to stop the daemon then call the close
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (i <span style=color:#000;font-weight:700>*</span>idleConn) <span style=color:#0086b3>close</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    _ = i.<span style=color:#900;font-weight:700>Close</span>() <span style=color:#998;font-style:italic>// i.WebsocketConn.Close()
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#998;font-style:italic></span>    i.p.<span style=color:#0086b3>delete</span>(i.<span style=color:#900;font-weight:700>Key</span>()) <span style=color:#998;font-style:italic>// i.WebsocketConn.Key() =&gt; uid
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#998;font-style:italic></span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#000;font-weight:700>func</span> (i <span style=color:#000;font-weight:700>*</span>idleConn) <span style=color:#900;font-weight:700>stop</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    i.stopChan <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#000;font-weight:700>struct</span>{}{}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#000;font-weight:700>func</span> (i <span style=color:#000;font-weight:700>*</span>idleConn) <span style=color:#900;font-weight:700>daemon</span>() {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    ticker <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>NewTicker</span>(config.Interval <span style=color:#000;font-weight:700>*</span> time.Second)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>loop:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#000;font-weight:700>for</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span> ticker.C:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>             <span style=color:#998;font-style:italic>// check last ping time and decide whether stop daemon.
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>i.ctx.<span style=color:#900;font-weight:700>Done</span>():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#998;font-style:italic>// WebsocketConn ctx cancelled
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#998;font-style:italic></span>            log.<span style=color:#900;font-weight:700>Error</span>(<span style=color:#d14>&#34;conn done&#34;</span>, <span style=color:#d14>&#34;key&#34;</span>, i.<span style=color:#900;font-weight:700>Key</span>())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>            <span style=color:#000;font-weight:700>break</span> loop
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>            <span style=color:#998;font-style:italic>//  stop() called
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>i.stopChan:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            log.<span style=color:#900;font-weight:700>Info</span>(<span style=color:#d14>&#34;conn stop&#34;</span>, <span style=color:#d14>&#34;key&#34;</span>, i.<span style=color:#900;font-weight:700>Key</span>())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>            <span style=color:#000;font-weight:700>break</span> loop
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#000;font-weight:700>case</span> data <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>&lt;-</span>i.writeChan:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            i.<span style=color:#900;font-weight:700>writeToClient</span>(data) <span style=color:#998;font-style:italic>// write msg to client
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span><span style=color:#998;font-style:italic></span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>    log.<span style=color:#900;font-weight:700>Info</span>(<span style=color:#d14>&#34;conn daemon exit&#34;</span>, <span style=color:#d14>&#34;key&#34;</span>, i.<span style=color:#900;font-weight:700>Key</span>())
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    i.<span style=color:#0086b3>close</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>}
</span></span></code></pre></div><p><code>idleConn</code> 能力相对纯粹，维护连接可用性和特殊情况下从连接池剔除当前连接。</p><p>下面看一下连接池的定义和实现：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>type</span> namedPool <span style=color:#000;font-weight:700>struct</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#000;font-weight:700>*</span>sync.RWMutex
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    m <span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>string</span>]<span style=color:#000;font-weight:700>*</span>idleConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>newNamedPool</span>() <span style=color:#000;font-weight:700>*</span>namedPool {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    p <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>&amp;</span>namedPool{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        RWMutex: <span style=color:#0086b3>new</span>(sync.RWMutex),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        m:       <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>map</span>[<span style=color:#458;font-weight:700>string</span>]<span style=color:#000;font-weight:700>*</span>idleConn),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#000;font-weight:700>return</span> p
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#998;font-style:italic>// 添加连接
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#900;font-weight:700>add</span>(c <span style=color:#000;font-weight:700>*</span>WebsocketConn) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>c.ctx.<span style=color:#900;font-weight:700>Done</span>():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    <span style=color:#000;font-weight:700>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#000;font-weight:700>if</span> c.<span style=color:#900;font-weight:700>Err</span>() <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>            <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    p.<span style=color:#900;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#000;font-weight:700>defer</span> p.<span style=color:#900;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    <span style=color:#998;font-style:italic>// 若已存在 则先停止上一个 daemon
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#998;font-style:italic></span>    i, loaded <span style=color:#000;font-weight:700>:=</span> p.m[c.<span style=color:#900;font-weight:700>Key</span>()]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>    <span style=color:#000;font-weight:700>if</span> loaded {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>        i.<span style=color:#900;font-weight:700>stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>    i = <span style=color:#000;font-weight:700>&amp;</span>idleConn{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>        WebsocketConn: c,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>        stopChan:      <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>struct</span>{}),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>        p:             p,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>    <span style=color:#998;font-style:italic>// TODO: 使用可控大小的 goroutine 池，防止goroutine 泄露
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#998;font-style:italic></span>    <span style=color:#000;font-weight:700>go</span> i.<span style=color:#900;font-weight:700>daemon</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>    p.m[c.<span style=color:#900;font-weight:700>Key</span>()] = i
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#900;font-weight:700>get</span>(key <span style=color:#458;font-weight:700>string</span>) <span style=color:#000;font-weight:700>*</span>WebsocketConn {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>    p.<span style=color:#900;font-weight:700>RLock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    i, ok <span style=color:#000;font-weight:700>:=</span> p.m[key]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>    p.<span style=color:#900;font-weight:700>RUnlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    <span style=color:#000;font-weight:700>if</span> ok {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>        <span style=color:#998;font-style:italic>// 拿连接时 先判断是否已失效
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span><span style=color:#998;font-style:italic></span>        <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>        <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>i.ctx.<span style=color:#900;font-weight:700>Done</span>():
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>            i.<span style=color:#900;font-weight:700>stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>        <span style=color:#000;font-weight:700>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>            <span style=color:#000;font-weight:700>if</span> i.<span style=color:#900;font-weight:700>Err</span>() <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>                i.<span style=color:#900;font-weight:700>stop</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>                <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>            <span style=color:#000;font-weight:700>return</span> i.WebsocketConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span><span style=color:#998;font-style:italic>// 需要读取所有连接做全量推送的需求
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#900;font-weight:700>loadAllConns</span>() <span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>*</span>WebsocketConn {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    p.<span style=color:#900;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>    <span style=color:#000;font-weight:700>defer</span> p.<span style=color:#900;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>    ch <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>chan</span> <span style=color:#000;font-weight:700>*</span>WebsocketConn, <span style=color:#0086b3>len</span>(p.m))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>    <span style=color:#000;font-weight:700>for</span> _, i <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>range</span> p.m {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        ch <span style=color:#000;font-weight:700>&lt;-</span> i.WebsocketConn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>    <span style=color:#0086b3>close</span>(ch)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>    <span style=color:#000;font-weight:700>return</span> ch
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span><span style=color:#000;font-weight:700>func</span> (p <span style=color:#000;font-weight:700>*</span>namedPool) <span style=color:#0086b3>delete</span>(key <span style=color:#458;font-weight:700>string</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span>    p.<span style=color:#900;font-weight:700>Lock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>    <span style=color:#000;font-weight:700>defer</span> p.<span style=color:#900;font-weight:700>Unlock</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>    <span style=color:#0086b3>delete</span>(p.m, key)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>}
</span></span></code></pre></div><p>经过 <code>idleConn</code> 和 <code>namedPool</code> 配合，连接管理算是达到预期的要求了且通过了测试，后期可以做一些优化项。</p><h2 id=消息推送>消息推送 <a href=#%e6%b6%88%e6%81%af%e6%8e%a8%e9%80%81 class=anchor aria-hidden=true>#</a></h2><p>在解决了非业务层的各种问题后，现在只剩下消息推送的问题了。消息推送最开始其实直接调用的框架提供的原生方法 <code>WriteMessage</code>,即需要推送时，从连接池拿到对应的连接然后直接调用写消息的方法，但是有大量消息需要写入时可能会出现消息顺序异常的问题，因此在 <code>WebsocketConn</code> 层屏蔽了原生的方法，并添加一个消息 <code>channel</code> 来控制并发带来的消息顺序异常问题。</p><p>新增消息 <code>channel</code> :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    conn *websocket.Conn
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ctx    context.Context
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    cancel context.CancelFunc
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    uid          string
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    // 消息 channel
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    writeChan    chan []byte
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    // 无法写到客户端时回调该方法 上层一般会进行重试或写到 mq 待会儿进行处理
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    onWriteError func()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    err          error
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>新的写消息方法：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>Write</span>(data []<span style=color:#458;font-weight:700>byte</span>) <span style=color:#458;font-weight:700>error</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>case</span> w.writeChan <span style=color:#000;font-weight:700>&lt;-</span> data:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#000;font-weight:700>default</span>:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#998;font-style:italic>// 尝试等待一小段时间，如果这段时间内写入失败则直接报错，这种情况下大概率是服务端与客户端的连接异常，消息阻塞了
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic></span>    timer <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>NewTimer</span>(time.Millisecond <span style=color:#000;font-weight:700>*</span> <span style=color:#099>10</span>)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>select</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>case</span> w.writeChan <span style=color:#000;font-weight:700>&lt;-</span> data:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>timer.C:
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#000;font-weight:700>return</span> ErrWriteChanFull
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p>写入到 <code>writeChan</code> 后，由上述 <code>idleConn.daemon</code> 方法读取 <code>channel</code> 内消息后，调用以下方法来正式写入的ws 上：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>func</span> (w <span style=color:#000;font-weight:700>*</span>WebsocketConn) <span style=color:#900;font-weight:700>writeToClient</span>(data []<span style=color:#458;font-weight:700>byte</span>) {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    _ = w.conn.<span style=color:#900;font-weight:700>SetWriteDeadline</span>(time.<span style=color:#900;font-weight:700>Now</span>().<span style=color:#900;font-weight:700>Add</span>(time.Second))
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    err <span style=color:#000;font-weight:700>:=</span> w.conn.<span style=color:#900;font-weight:700>WriteMessage</span>(websocket.TextMessage, data)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        w.<span style=color:#900;font-weight:700>onWriteError</span>()
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        <span style=color:#000;font-weight:700>return</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>至此，消息的推送也解决了已遇到的问题。</p><h2 id=总结>总结 <a href=#%e6%80%bb%e7%bb%93 class=anchor aria-hidden=true>#</a></h2><p>本文记录了在开发 goim 的推送服务(长连接服务)时遇到的一些问题和解决方案，方便理解在看相关代码时其背后的思考。</p><p>内容分为三个部分：</p><ul><li>websocket 连接中的一些事件处理和如何与业务关联起来</li><li>websocket 连接池的维护</li><li>在聊天系统中确保消息推送的顺序</li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://go-goim.github.io/js/bootstrap.min.0a0106334435d4110713bfaff4acaf02533b0c56d44412a74e9518db07672ddb7e099a9c7517bc9cb529e2ddd4ae2e438b40b720288900d5e74fb6d8928d9097.js integrity="sha512-CgEGM0Q11BEHE7+v9KyvAlM7DFbURBKnTpUY2wdnLdt+CZqcdRe8nLUp4t3Uri5Di0C3ICiJANXnT7bYko2Qlw==" crossorigin=anonymous defer></script>
<script src=https://go-goim.github.io/main.min.8af0270b47fb32a37fe246141900e6daf60fd994e5e871a785199a9779f9dbd0eeae617675535eb47b71f7190ad25f8df4477b6cfd453c1879bea3a35e290333.js integrity="sha512-ivAnC0f7MqN/4kYUGQDm2vYP2ZTl6HGnhRmal3n529DurmF2dVNetHtx9xkK0l+N9Ed7bP1FPBh5vqOjXikDMw==" crossorigin=anonymous defer></script></body></html>